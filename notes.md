# AWS Cloud Services and CLI 

***

## 1. Introduction to AWS

- **AWS (Amazon Web Services)**: A broad cloud computing platform offering numerous services.

### Main AWS Service Categories Used:
- **Compute**: e.g., EC2 – scalable virtual servers.
- **Storage**: solutions like S3, EBS, etc.
- **Networking & Content Delivery**: VPC (Virtual Private Cloud) to manage network and firewall settings.
- **Security, Identity & Compliance**: IAM (Identity and Access Management).
- **Containers**: services for container management.

### AWS Resource Scopes:
- **Global**: Account-wide settings such as IAM users, billing, DNS (Route53).
- **Regions**: Geographically distinct locations (e.g., eu-central-1) hosting services like S3, VPC, DynamoDB.
- **Availability Zones (AZs)**: Physically separate datacenters within regions hosting virtual machines (EC2, EBS, RDS).

***

## 2. AWS Account Creation

- Register a new account on [AWS Signup page](https://portal.aws.amazon.com/billing/signup).
- Complete the sign-up form, enter payment info, and activate your account.

***

## 3. IAM – Managing Users, Roles, and Permissions

- **IAM** controls access to AWS resources.
- Default **root user** has unlimited privileges; create an admin user with limited necessary permissions.
- Use **groups** to manage user permissions collectively.
- For services to have permissions, create **roles** with assigned privileges, then attach these roles to specific services.  
- **Roles are service-specific**; a role cannot be shared across services.

### Creating an Admin User
- Go to IAM > Users > Add User.
- Provide username (e.g., 'admin').
- Enable AWS Management Console access with autogenerated password (user must reset on first login).
- Attach **AdministratorAccess** policy.
- Copy user credentials & sign-in URL securely.
  
### Generating Programmatic Access Key
- After admin user creation, create **Access Key ID** and **Secret Access Key** under Security Credentials.
- Save keys securely.

***

## 4. AWS Regions & Availability Zones

- AWS has ~30 regions worldwide.
- Each region has multiple availability zones for redundancy and replication.
- Services must be created in a specific region.

***

## 5. VPC – Virtual Private Cloud Network

- Every region has its own VPC.
- Availability Zones reside inside subnets of the VPC.
- Subnets can be:
  - **Public**: Allow inbound access from outside (internet).
  - **Private**: Firewall blocks all external incoming traffic.
- Services can receive:
  - **Private IP** for internal VPC communication.
  - **Public IP** for internet accessibility.
- Access is regulated with:
  - **Network Access Control Lists (NACLs)** at subnet level.
  - **Security Groups** at instance (service) level.

***

## 6. CIDR Blocks (Classless Inter-Domain Routing)

- Defines IP address ranges for networks/subnets.
- Example: `172.31.0.0/16` includes IPs from `172.31.0.0` to `172.31.255.255`.
- Useful tools:
  - [IP Calculator](https://jodies.de/ipcalc?host=10.0.0.0&mask1=16&mask2=)
  - [Subnet Calculator](https://mxtoolbox.com/subnetcalculator.aspx)
  - [Subnet Divider](https://www.davidc.net/sites/default/subnets/subnets.html)

***

## 7. EC2 – Elastic Compute Cloud (Virtual Server)

### Creating an EC2 Instance (Example Web Server Deployment)

1. Navigate to EC2 in AWS Console → Launch Instance.
2. Enter basic configuration:
   - Name (e.g., 'web-server').
   - Add tag: key `Type` value `web-server-with-docker`.
3. Choose Amazon Machine Image (AMI): Select “Amazon Linux”.
4. Select instance type:
   - Free tier eligible option: `t2.micro`.
5. Create and download **Key Pair**:
   - Name: `docker-server`
   - Type: RSA, `.pem` file downloaded for SSH access.
6. Configure Network:
   - Enable "Auto-assign public IP".
   - Create Security Group:
     - Name: `security-group-docker-server`
     - Restrict SSH rule source to "My IP".
7. Storage: Default settings okay.
8. Launch instance.

### Connecting to EC2 Instance

- Move private key file to SSH folder: `~/.ssh/docker-server.pem`.
- Restrict permissions: `chmod 400 ~/.ssh/docker-server.pem`.
- SSH:  
  ```bash
  ssh -i ~/.ssh/docker-server.pem ec2-user@
  ```

### Installing Docker on EC2

```bash
sudo yum update
sudo yum install docker
sudo service docker start
sudo usermod -aG docker ec2-user  # enables docker usage without sudo
exit                             # relogin for group changes to effect
```

### Running Web Application on EC2

- Build and push Docker image from dev machine:

```bash
docker build -t fsiegrist/fesi-repo:devops-bootcamp-react-nodjs-1.0 .
docker login
docker push fsiegrist/fesi-repo:devops-bootcamp-react-nodjs-1.0
```

> Note for Apple M1/M2 (arm64) users building for amd64 Linux hosts:
> Use multi-platform build with `docker buildx` or specify platform in Dockerfile.

- Pull and run image on EC2:

```bash
docker login
docker pull --platform linux/amd64 fsiegrist/fesi-repo:devops-bootcamp-react-nodjs-1.0
docker run -d -p 3000:3080 fsiegrist/fesi-repo:devops-bootcamp-react-nodjs-1.0
```

### Allow Public Access to Application

- Add inbound rule to EC2 security group for TCP port **3000** open to all IPv4.

- Access the application from browser at:  
  `http://:3000`

***

## 8. Deploying to EC2 from Jenkins Pipeline

### Manual Docker Container Deployment

- Install Jenkins SSH Agent plugin.
- Add SSH credentials (username: `ec2-user`, private key from `.pem` file).
- Use SSH agent block in Jenkinsfile to run remote Docker run commands.

Example deploy stage snippet:

```groovy
stage('Deploy Application') {
  steps {
    sshagent(['ec2-server-key']) {
      sh "ssh -o StrictHostKeyChecking=no ec2-user@ 'docker run -d -p 8000:8080 fsiegrist/fesi-repo:devops-bootcamp-java-maven-app-${IMAGE_TAG}'"
    }
  }
}
```

### Important EC2 Pre-requisites:

- Allow Jenkins server IP in EC2 security group's inbound SSH rule.
- Log in to Docker Hub from EC2 once to cache login credentials.
- Open required application ports (e.g., 8000) in EC2 security group.

### Using Docker Compose for Multi-Container Apps

- Install Docker Compose on EC2:

```bash
sudo curl -SL https://github.com/docker/compose/releases/download/v2.17.2/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
docker-compose --version
```

- Define `docker-compose.yaml` including app container and dependencies (e.g., postgres).

- Deploy via Jenkinsfile with SCP and remote docker-compose command execution:

```groovy
stage('Deploy Application') {
  steps {
    sshagent(['ec2-server-key']) {
      sh 'scp -o StrictHostKeyChecking=no docker-compose.yaml ec2-user@:/home/ec2-user'
      sh "ssh -o StrictHostKeyChecking=no ec2-user@ 'IMAGE_TAG=${IMAGE_TAG} docker-compose -f docker-compose.yaml up -d'"
    }
  }
}
```

- For better reuse, place deploy logic in shell script (`server-cmds.sh`):

```bash
#!/usr/bin/env bash
export IMAGE_TAG=$1
docker-compose -f docker-compose.yaml up -d
echo "Containers started successfully."
```

And call it remotely from Jenkins pipeline similarly.

***

## 9. AWS CLI – Command Line Interface

- Everything done via AWS Management Console can be replicated on CLI.

### Installation

- Mac example:  
```bash
brew update
brew install awscli
```

### Configuration

- Run `aws configure` to set AWS Access Key ID, Secret Access Key, default region, and output format (e.g., JSON).
- Credentials and config stored under `~/.aws/credentials` and `~/.aws/config`.

### Command Format

```
aws   [options]
```

Example to launch an instance:

```bash
aws ec2 run-instances --image-id ami-xxxxxx --count 1 --instance-type t2.micro --key-name MyKeyPair --security-group-ids sg-xxxxxx --subnet-id subnet-xxxxxx
```

***

## 10. AWS CLI Useful Commands

- Managing security groups:
  - `aws ec2 describe-security-groups`
  - Create security group:
    ```bash
    aws ec2 create-security-group --group-name my-sg --description "My Security Group" --vpc-id vpc-xxxxxx
    ```
  - Add ingress rule:
    ```bash
    aws ec2 authorize-security-group-ingress --group-id sg-xxxxxx --protocol tcp --port 22 --cidr 31.10.151.111/32
    ```

- Creating key pairs via CLI:
  ```bash
  aws ec2 create-key-pair --key-name MyKpCli --query 'KeyMaterial' --output text > MyKpCli.pem
  ```

- Describing subnets, instances, images, filtering, and querying with `--filters` and `--query` options for selective results.

***

## 11. IAM User and Group Management via AWS CLI

- Create group:
  ```bash
  aws iam create-group --group-name MyGroupCli
  ```

- Create user:
  ```bash
  aws iam create-user --user-name MyUserCli
  ```

- Add user to group:
  ```bash
  aws iam add-user-to-group --user-name MyUserCli --group-name MyGroupCli
  ```

- Attach policy to group (e.g., AmazonEC2FullAccess).

- Create login profile (console password):
  ```bash
  aws iam create-login-profile --user-name MyUserCli --password TopSecretInitialPassword123 --password-reset-required
  ```

- Create custom policy (IAMUserChangePassword) and attach to group for password change permission.

- Create access keys for CLI access:
  ```bash
  aws iam create-access-key --user-name MyUserCli
  ```

***

## 12. User Profile Switching & Cleanup

- Switch AWS CLI user by running `aws configure` again or by setting specific environment variables `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`.
- Delete AWS resources using corresponding `delete` CLI commands.
- Use `aws  help | grep delete` to find delete subcommands.

***
